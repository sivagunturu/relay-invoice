{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/sivagunturu/Documents/relay-invoice/src/lib/actions/invoices.ts"],"sourcesContent":["'use server';\n\nimport { createClient as createSupabaseClient, createServiceClient } from '@/lib/supabase/server';\nimport { getUserOrganization } from './organizations';\nimport { getUser } from './auth';\nimport { revalidatePath } from 'next/cache';\nimport { redirect } from 'next/navigation';\nimport { calculateDueDate } from '../utils';\n\nexport async function getInvoices() {\n  const supabase = await createSupabaseClient();\n  const org = await getUserOrganization();\n\n  if (!org) throw new Error('No organization found');\n\n  const { data, error } = await supabase\n    .from('invoices')\n    .select(`\n      *,\n      clients (id, name)\n    `)\n    .eq('org_id', org.id)\n    .order('created_at', { ascending: false });\n\n  if (error) throw new Error(error.message);\n  return data;\n}\n\nexport async function getInvoice(id: string) {\n  const supabase = await createSupabaseClient();\n  const org = await getUserOrganization();\n\n  if (!org) throw new Error('No organization found');\n\n  const { data, error } = await supabase\n    .from('invoices')\n    .select(`\n      *,\n      clients (*),\n      invoice_items (*)\n    `)\n    .eq('id', id)\n    .eq('org_id', org.id)\n    .single();\n\n  if (error) throw new Error(error.message);\n  return data;\n}\n\nexport async function createInvoiceFromTemplate(templateId: string, month: string) {\n  const supabase = await createSupabaseClient();\n  const org = await getUserOrganization();\n  const user = await getUser();\n\n  if (!org || !user) throw new Error('Authentication required');\n\n  // Get template with items\n  const { data: template } = await supabase\n    .from('invoice_templates')\n    .select(`\n      *,\n      clients (*),\n      invoice_template_items (*)\n    `)\n    .eq('id', templateId)\n    .eq('org_id', org.id)\n    .single();\n\n  if (!template) throw new Error('Template not found');\n\n  // Get org settings for invoice numbering\n  const { data: settings } = await supabase\n    .from('org_settings')\n    .select('*')\n    .eq('org_id', org.id)\n    .single();\n\n  if (!settings) throw new Error('Settings not found');\n\n  // Generate invoice number using database function\n  const { data: invoiceNumberResult } = await supabase\n    .rpc('generate_invoice_number', {\n      p_org_id: org.id,\n      p_month: month,\n    });\n\n  const invoiceNumber = invoiceNumberResult as string;\n\n  // Calculate dates\n  const issueDate = new Date();\n  const dueDate = calculateDueDate(issueDate, settings.default_terms);\n\n  // Create invoice\n  const { data: invoice, error: invoiceError } = await supabase\n    .from('invoices')\n    .insert({\n      org_id: org.id,\n      client_id: template.client_id,\n      template_id: templateId,\n      invoice_number: invoiceNumber,\n      issue_date: issueDate.toISOString().split('T')[0],\n      due_date: dueDate.toISOString().split('T')[0],\n      month,\n      status: 'draft',\n      terms: settings.default_terms,\n      currency: settings.default_currency,\n      payment_instructions: settings.payment_instructions,\n      compliance_text: settings.compliance_text,\n    })\n    .select()\n    .single();\n\n  if (invoiceError) throw new Error(invoiceError.message);\n\n  // Create invoice items from template\n  if (template.invoice_template_items && template.invoice_template_items.length > 0) {\n    const items = template.invoice_template_items.map((item: any, index: number) => ({\n      org_id: org.id,\n      invoice_id: invoice.id,\n      description: item.description,\n      qty: item.qty_default,\n      rate: item.rate_default,\n      amount: parseFloat(item.qty_default) * parseFloat(item.rate_default),\n      sort_order: index,\n    }));\n\n    await supabase.from('invoice_items').insert(items);\n  }\n\n  revalidatePath('/invoices');\n  redirect(`/invoices/${invoice.id}/edit`);\n}\n\nexport async function createInvoice(formData: FormData) {\n  const supabase = await createSupabaseClient();\n  const org = await getUserOrganization();\n\n  if (!org) throw new Error('No organization found');\n\n  const clientId = formData.get('clientId') as string;\n  const issueDate = formData.get('issueDate') as string;\n  const month = formData.get('month') as string;\n  const terms = formData.get('terms') as string;\n  const currency = formData.get('currency') as string;\n\n  // Get org settings\n  const { data: settings } = await supabase\n    .from('org_settings')\n    .select('*')\n    .eq('org_id', org.id)\n    .single();\n\n  if (!settings) throw new Error('Settings not found');\n\n  // Generate invoice number\n  const { data: invoiceNumberResult } = await supabase\n    .rpc('generate_invoice_number', {\n      p_org_id: org.id,\n      p_month: month,\n    });\n\n  const invoiceNumber = invoiceNumberResult as string;\n\n  const dueDate = calculateDueDate(new Date(issueDate), terms);\n\n  const { data: invoice, error } = await supabase\n    .from('invoices')\n    .insert({\n      org_id: org.id,\n      client_id: clientId,\n      invoice_number: invoiceNumber,\n      issue_date: issueDate,\n      due_date: dueDate.toISOString().split('T')[0],\n      month,\n      status: 'draft',\n      terms,\n      currency,\n      payment_instructions: settings.payment_instructions,\n      compliance_text: settings.compliance_text,\n    })\n    .select()\n    .single();\n\n  if (error) throw new Error(error.message);\n\n  revalidatePath('/invoices');\n  redirect(`/invoices/${invoice.id}/edit`);\n}\n\nexport async function updateInvoiceItems(invoiceId: string, itemsJson: string) {\n  const supabase = await createSupabaseClient();\n  const org = await getUserOrganization();\n\n  if (!org) throw new Error('No organization found');\n\n  const items = JSON.parse(itemsJson);\n\n  // Calculate totals\n  let subtotal = 0;\n  items.forEach((item: any) => {\n    subtotal += parseFloat(item.qty) * parseFloat(item.rate);\n  });\n\n  const tax = 0; // Phase 1: no tax\n  const total = subtotal + tax;\n\n  // Delete existing items\n  await supabase\n    .from('invoice_items')\n    .delete()\n    .eq('invoice_id', invoiceId);\n\n  // Insert new items\n  const itemsToInsert = items.map((item: any, index: number) => ({\n    org_id: org.id,\n    invoice_id: invoiceId,\n    description: item.description,\n    qty: item.qty,\n    rate: item.rate,\n    amount: parseFloat(item.qty) * parseFloat(item.rate),\n    sort_order: index,\n  }));\n\n  await supabase.from('invoice_items').insert(itemsToInsert);\n\n  // Update invoice totals\n  await supabase\n    .from('invoices')\n    .update({\n      subtotal: subtotal.toString(),\n      tax: tax.toString(),\n      total: total.toString(),\n    })\n    .eq('id', invoiceId)\n    .eq('org_id', org.id);\n\n  revalidatePath(`/invoices/${invoiceId}`);\n  return { success: true };\n}\n\nexport async function generateInvoicePDF(invoiceId: string) {\n  const supabase = await createServiceClient();\n  const org = await getUserOrganization();\n  const user = await getUser();\n\n  if (!org || !user) throw new Error('Authentication required');\n\n  // Create job for PDF generation\n  const { data: job, error } = await supabase\n    .from('jobs')\n    .insert({\n      org_id: org.id,\n      type: 'generate_pdf',\n      payload_json: {\n        invoice_id: invoiceId,\n        user_id: user.id,\n      },\n      status: 'queued',\n    })\n    .select()\n    .single();\n\n  if (error) throw new Error(error.message);\n\n  // Create audit log\n  await supabase.from('audit_log').insert({\n    org_id: org.id,\n    user_id: user.id,\n    action: 'generate_pdf_queued',\n    entity_type: 'invoice',\n    entity_id: invoiceId,\n    metadata_json: { job_id: job.id },\n  });\n\n  revalidatePath(`/invoices/${invoiceId}`);\n  return { success: true, jobId: job.id };\n}\n\nexport async function deleteInvoice(id: string) {\n  const supabase = await createSupabaseClient();\n  const org = await getUserOrganization();\n\n  if (!org) throw new Error('No organization found');\n\n  const { error } = await supabase\n    .from('invoices')\n    .delete()\n    .eq('id', id)\n    .eq('org_id', org.id);\n\n  if (error) throw new Error(error.message);\n\n  revalidatePath('/invoices');\n  return { success: true };\n}\n"],"names":[],"mappings":";;;;;;;MA6LsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,sDAAA"}},
    {"offset": {"line": 21, "column": 0}, "map": {"version":3,"sources":["file:///Users/sivagunturu/Documents/relay-invoice/src/components/ui/card.tsx"],"sourcesContent":["import { ReactNode } from 'react';\n\nexport function Card({ children, className = '' }: { children: ReactNode; className?: string }) {\n  return (\n    <div className={`bg-white rounded-lg shadow p-6 ${className}`}>\n      {children}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;;AAEO,SAAS,KAAK,EAAE,QAAQ,EAAE,YAAY,EAAE,EAA+C;IAC5F,qBACE,6LAAC;QAAI,WAAW,CAAC,+BAA+B,EAAE,WAAW;kBAC1D;;;;;;AAGP;KANgB"}},
    {"offset": {"line": 47, "column": 0}, "map": {"version":3,"sources":["file:///Users/sivagunturu/Documents/relay-invoice/src/components/ui/input.tsx"],"sourcesContent":["import { InputHTMLAttributes } from 'react';\n\ninterface InputProps extends InputHTMLAttributes<HTMLInputElement> {\n  label?: string;\n}\n\nexport function Input({ label, className = '', ...props }: InputProps) {\n  return (\n    <div className=\"mb-4\">\n      {label && (\n        <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n          {label}\n        </label>\n      )}\n      <input\n        className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${className}`}\n        {...props}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;;AAMO,SAAS,MAAM,EAAE,KAAK,EAAE,YAAY,EAAE,EAAE,GAAG,OAAmB;IACnE,qBACE,6LAAC;QAAI,WAAU;;YACZ,uBACC,6LAAC;gBAAM,WAAU;0BACd;;;;;;0BAGL,6LAAC;gBACC,WAAW,CAAC,uGAAuG,EAAE,WAAW;gBAC/H,GAAG,KAAK;;;;;;;;;;;;AAIjB;KAdgB"}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///Users/sivagunturu/Documents/relay-invoice/src/components/ui/button.tsx"],"sourcesContent":["import { ButtonHTMLAttributes } from 'react';\n\ninterface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {\n  variant?: 'primary' | 'secondary' | 'danger';\n}\n\nexport function Button({ variant = 'primary', className = '', ...props }: ButtonProps) {\n  const baseStyles = 'px-4 py-2 rounded-md font-medium transition-colors';\n  const variants = {\n    primary: 'bg-blue-600 text-white hover:bg-blue-700',\n    secondary: 'bg-gray-200 text-gray-900 hover:bg-gray-300',\n    danger: 'bg-red-600 text-white hover:bg-red-700',\n  };\n\n  return (\n    <button\n      className={`${baseStyles} ${variants[variant]} ${className}`}\n      {...props}\n    />\n  );\n}\n"],"names":[],"mappings":";;;;;;AAMO,SAAS,OAAO,EAAE,UAAU,SAAS,EAAE,YAAY,EAAE,EAAE,GAAG,OAAoB;IACnF,MAAM,aAAa;IACnB,MAAM,WAAW;QACf,SAAS;QACT,WAAW;QACX,QAAQ;IACV;IAEA,qBACE,6LAAC;QACC,WAAW,GAAG,WAAW,CAAC,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,WAAW;QAC3D,GAAG,KAAK;;;;;;AAGf;KAdgB"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///Users/sivagunturu/Documents/relay-invoice/src/app/%28dashboard%29/invoices/%5Bid%5D/edit/page.tsx"],"sourcesContent":["'use client';\n\nimport { useState, useEffect } from 'react';\nimport { updateInvoiceItems } from '@/lib/actions/invoices';\nimport { Card } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport Link from 'next/link';\nimport { use } from 'react';\n\nexport default function EditInvoicePage({ \n  params \n}: { \n  params: Promise<{ id: string }> \n}) {\n  const { id } = use(params);\n  const [items, setItems] = useState([{ description: 'IT Consulting Services â€“ Mounika Vadlamudi', qty: 88, rate: 65 }]);\n  const [saving, setSaving] = useState(false);\n\n  function addItem() {\n    setItems([...items, { description: '', qty: 0, rate: 0 }]);\n  }\n\n  function removeItem(index: number) {\n    setItems(items.filter((_, i) => i !== index));\n  }\n\n  async function handleSave() {\n    setSaving(true);\n    try {\n      await updateInvoiceItems(id, JSON.stringify(items));\n      window.location.href = `/invoices/${id}`;\n    } catch (error) {\n      alert('Error saving invoice items');\n      setSaving(false);\n    }\n  }\n\n  return (\n    <div className=\"max-w-4xl\">\n      <h1 className=\"text-3xl font-bold mb-8\">Edit Invoice Items</h1>\n\n      <Card>\n        <div className=\"space-y-4\">\n          {items.map((item, index) => (\n            <div key={index} className=\"border p-4 rounded\">\n              <Input \n                label=\"Description *\" \n                value={item.description}\n                onChange={(e) => {\n                  const newItems = [...items];\n                  newItems[index].description = e.target.value;\n                  setItems(newItems);\n                }}\n                required\n              />\n              <div className=\"grid grid-cols-3 gap-4\">\n                <Input \n                  label=\"Quantity *\" \n                  type=\"number\"\n                  step=\"0.01\"\n                  value={item.qty}\n                  onChange={(e) => {\n                    const newItems = [...items];\n                    newItems[index].qty = parseFloat(e.target.value) || 0;\n                    setItems(newItems);\n                  }}\n                  required\n                />\n                <Input \n                  label=\"Rate *\" \n                  type=\"number\"\n                  step=\"0.01\"\n                  value={item.rate}\n                  onChange={(e) => {\n                    const newItems = [...items];\n                    newItems[index].rate = parseFloat(e.target.value) || 0;\n                    setItems(newItems);\n                  }}\n                  required\n                />\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    Amount\n                  </label>\n                  <div className=\"px-3 py-2 bg-gray-50 rounded-md\">\n                    ${(item.qty * item.rate).toFixed(2)}\n                  </div>\n                </div>\n              </div>\n              {items.length > 1 && (\n                <Button \n                  type=\"button\" \n                  variant=\"danger\" \n                  onClick={() => removeItem(index)}\n                  className=\"text-sm mt-2\"\n                >\n                  Remove Item\n                </Button>\n              )}\n            </div>\n          ))}\n          \n          <Button type=\"button\" variant=\"secondary\" onClick={addItem}>\n            Add Item\n          </Button>\n        </div>\n\n        <div className=\"mt-6 pt-6 border-t\">\n          <div className=\"text-right mb-4\">\n            <p className=\"text-lg\">\n              <span className=\"font-semibold\">Subtotal:</span> $\n              {items.reduce((sum, item) => sum + (item.qty * item.rate), 0).toFixed(2)}\n            </p>\n            <p className=\"text-lg\">\n              <span className=\"font-semibold\">Tax:</span> $0.00\n            </p>\n            <p className=\"text-2xl font-bold\">\n              <span>Total:</span> $\n              {items.reduce((sum, item) => sum + (item.qty * item.rate), 0).toFixed(2)}\n            </p>\n          </div>\n          \n          <div className=\"flex gap-4\">\n            <Button onClick={handleSave} disabled={saving}>\n              {saving ? 'Saving...' : 'Save Items'}\n            </Button>\n            <Link href={`/invoices/${id}`}>\n              <Button type=\"button\" variant=\"secondary\">\n                Cancel\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </Card>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}